<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Mic Test</title>
</head>
<body>
<button id="control">Record</button>
<script>
	let shouldStop = false;
	let shouldStart = false;
	let running = false;
	let btnRec = true;
	let socket = new WebSocket("ws://devin:pas@localhost:3001/stream-audio");
	let control = document.getElementById("control");

	control.addEventListener('click', function () {
		if (btnRec) {
			shouldStart = true;
			shouldStop = false;
			btnRec = false;
			document.getElementById("control").innerHTML = "Stop";
		} else {
			shouldStop = true;
			shouldStart = false;
			btnRec = true;
			document.getElementById("control").innerHTML = "Record";
		}
	});

	console.log("Page loaded")

	const handleSuccess = function (stream) {
		const options = {mimeType: 'audio/webm;codecs=opus'};
		const recordedChunks = [];
		const mediaRecorder = new MediaRecorder(stream, options);
		console.log("MR created");

		mediaRecorder.addEventListener('dataavailable', function (e) {
			console.log("Data Available from MR");
			if (e.data.size > 0) {
				recordedChunks.push(e.data);
				console.log("push data to queue")
			}

			if (shouldStop && running) {
				console.log("should stop and stuff")
				mediaRecorder.stop();
				console.log(recordedChunks);
				socket.send(new Blob(recordedChunks));
				running = false;
			}
		});

		mediaRecorder.addEventListener('stop', function() {
			console.log("Stop MR");
			socket.send(new Blob(recordedChunks));
		});

		console.log("shouldStart: " + shouldStart + " running: " + running);
		if (shouldStart && !running) {
			console.log("Start MR");
			mediaRecorder.start();
			running = true;
		}
	};

	navigator.mediaDevices.getUserMedia({audio: true, video: false})
		.then(handleSuccess);

</script>
</body>
</html>